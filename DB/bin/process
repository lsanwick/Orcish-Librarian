#!/usr/bin/env ruby
# encoding: utf-8

require File.join(File.dirname(__FILE__), '../lib/bootstrap')

if ARGV.length == 1
  Dir.chdir ARGV[0]
else
  Dir.chdir "data"
end

sets_by_name = { }
search_names = [ ]

# collect all the relevant data for post-processing
Dir.glob("*").each do |set_name|
  if File.directory?(set_name)
    Dir.glob(File.join(set_name, '*.yml')).each do |file|
      File.open(file, 'r') do |io|
        begin 
          card = YAML.load(io)
          sets_by_name[card['name']] = sets_by_name[card['name']] || [ ]
          sets_by_name[card['name']] << set_name
        rescue Exception => e
          puts "Error loading YAML document: #{file}"
          puts e.to_s
        end        
      end
    end    
  end
end

sets_by_name.each do |name, sets|
  search_name = MtgCard.new(name).search_name
  search_names << search_name 
  # TODO: write index file  
end

# create search-by-name file
File.open('names.txt', 'w') do |io|
  io.write(search_names.sort.join(','))
end

# create index-by-name files
#names.each do |name, sets| 
#  File.open('names.txt', 'w') do |io|
#  io.write names.keys.sort.join(',')
#end
